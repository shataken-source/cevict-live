# Progno → Prognostication Syndication Pipeline

## Overview

Picks generated by the Progno engine are automatically syndicated to the
Prognostication website (`prognostication.com`) where they are served to
subscribers by tier (free / pro / elite).

```
Progno Engine
  └─ /api/picks/today  →  Supabase Storage (predictions-YYYY-MM-DD.json)
                                    │
                          npm run syndicate
                          OR Admin UI button
                                    │
                                    ▼
                    POST /api/webhooks/progno  (prognostication.com)
                                    │
                          syndicated_picks table
                          syndication_log table
                                    │
                                    ▼
                    /api/picks/today  →  Users by tier
```

---

## Tier Allocation

| Tier    | Confidence threshold | What users see                        |
|---------|----------------------|---------------------------------------|
| Elite   | ≥ 80%                | Full analysis, rationale, all fields  |
| Premium | 65–79%               | Full analysis, rationale, all fields  |
| Free    | < 65%                | Pick + confidence only (no analysis)  |

Sorting: picks are ranked by `composite_score` (or `value_bet_edge × 2.5 + confidence` as fallback) before tier assignment.

---

## How to Syndicate

### Option A — Admin UI (recommended)

1. Open Progno admin: `http://localhost:3008/admin`
2. Select the date in the date picker
3. Click **"Syndicate Now"** (orange button in the Action Cards section)
4. Status appears inline — green = success, red = error
5. Use **"Dry Run"** to preview without sending

### Option B — CLI script

```powershell
# From c:\cevict-live\apps\progno

npm run syndicate                          # today's picks
npm run syndicate -- --date=2026-02-22    # specific date
npm run syndicate:dry                      # dry run (no data sent)
```

### Option C — API call (from any service)

```http
POST http://localhost:3008/api/progno/admin/syndicate
Content-Type: application/json

{
  "date": "2026-02-22",
  "dryRun": false
}
```

Response:
```json
{
  "success": true,
  "date": "2026-02-22",
  "dryRun": false,
  "totalPicks": 9,
  "tiers": { "elite": 6, "premium": 2, "free": 1 },
  "results": [
    { "tier": "elite",   "count": 6, "success": true, "message": "Posted 6 picks" },
    { "tier": "premium", "count": 2, "success": true, "message": "Posted 2 picks" },
    { "tier": "free",    "count": 1, "success": true, "message": "Posted 1 picks" }
  ]
}
```

---

## Daily Workflow

```
8:00 AM  →  Run Predictions (admin UI or cron)
             Saves: predictions-2026-02-22.json to Supabase Storage

8:05 AM  →  Syndicate to Prognostication (admin UI or npm run syndicate)
             Picks appear on prognostication.com for subscribers
```

---

## Key Files

### Progno (sender)

| File | Purpose |
|------|---------|
| `scripts/syndicate-to-prognostication.ts` | CLI syndication script |
| `app/api/progno/admin/syndicate/route.ts` | Admin API endpoint (used by UI button) |
| `app/admin/page.tsx` | Admin UI — "Send to Prognostication" card |
| `.env.local` | Contains `PROGNOSTICATION_WEBHOOK_URL`, `PROGNO_INTERNAL_API_KEY` |

### Prognostication (receiver)

| File | Purpose |
|------|---------|
| `app/api/webhooks/progno/route.ts` | Webhook endpoint — receives and stores picks |
| `app/api/picks/today/route.ts` | Serves picks to users by tier |
| `supabase/migrations/003_syndicated_picks.sql` | Table schema |

---

## Environment Variables

### Progno `.env.local`

```env
PROGNO_INTERNAL_API_KEY=progno-internal-^J8Xpv0ENm3o-2026
PROGNOSTICATION_WEBHOOK_URL=https://prognostication.com/api/webhooks/progno
NEXT_PUBLIC_SUPABASE_URL=https://rdbuwyefbgnbuhmjrizo.supabase.co
SUPABASE_SERVICE_ROLE_KEY=<service role key>
```

### Prognostication `.env.local` + Vercel

```env
PROGNO_INTERNAL_API_KEY=progno-internal-^J8Xpv0ENm3o-2026   # must match Progno
NEXT_PUBLIC_SUPABASE_URL=https://rdbuwyefbgnbuhmjrizo.supabase.co
SUPABASE_SERVICE_ROLE_KEY=<service role key>
```

> **Important:** All env vars are managed via KeyVault.
> To update: `Set-KeyVaultSecret -Name "KEY" -Value "value"` then run
> `Sync-KeyVaultEnvFromManifest` for each app.
> To push to Vercel: use `scripts/keyvault/push-vercel.ps1` or the Vercel API directly.

---

## Supabase Tables (project: `rdbuwyefbgnbuhmjrizo`)

### `public.syndicated_picks`

| Column          | Type        | Notes                              |
|-----------------|-------------|------------------------------------|
| `id`            | uuid PK     | Auto-generated                     |
| `batch_id`      | text        | Groups picks from one syndication  |
| `tier`          | text        | `free`, `premium`, or `elite`      |
| `pick_index`    | integer     | Order within batch                 |
| `game_id`       | text        | Progno game identifier             |
| `sport`         | text        | `NBA`, `NFL`, `NCAAB`, etc.        |
| `home_team`     | text        |                                    |
| `away_team`     | text        |                                    |
| `pick_selection`| text        | The actual pick                    |
| `confidence`    | numeric     | 0–100                              |
| `odds`          | numeric     | American odds                      |
| `expected_value`| numeric     |                                    |
| `edge`          | numeric     | Value bet edge %                   |
| `analysis`      | text        | Full analysis text                 |
| `game_time`     | timestamptz |                                    |
| `created_at`    | timestamptz | Auto-set on insert                 |

### `public.syndication_log`

Audit trail. One row per batch per tier. Used for idempotency checks.

| Column       | Type        | Notes                    |
|--------------|-------------|--------------------------|
| `batch_id`   | text UNIQUE | Prevents duplicate sends |
| `tier`       | text        |                          |
| `pick_count` | integer     |                          |
| `success`    | boolean     |                          |
| `errors`     | jsonb       |                          |
| `created_at` | timestamptz |                          |

---

## Authentication

The webhook uses `x-progno-api-key` header. The key must match
`PROGNO_INTERNAL_API_KEY` in Prognostication's environment.

The admin API (`/api/progno/admin/syndicate`) accepts:
- `CRON_SECRET` in body or `x-admin-secret` header
- `ADMIN_PASSWORD` in body or `x-admin-secret` header

---

## KeyVault Integration

All secrets are stored in `C:\Cevict_Vault\env-store.json`.

```powershell
# Load module
Import-Module "c:\cevict-live\scripts\keyvault\KeyVault.psm1" -Force

# Read a secret
Get-KeyVaultSecret -Name "PROGNO_INTERNAL_API_KEY"

# Store a secret
Set-KeyVaultSecret -Name "PROGNOSTICATION_WEBHOOK_URL" -Value "https://..."

# Sync KeyVault → .env.local for an app
Sync-KeyVaultEnvFromManifest -AppPath "c:\cevict-live\apps\progno"
Sync-KeyVaultEnvFromManifest -AppPath "c:\cevict-live\apps\prognostication"

# Push to Vercel (uses keyvault.targets.json for project IDs)
powershell -File "c:\cevict-live\scripts\keyvault\push-vercel.ps1" -App "prognostication" -Env "production"
```

Each app has an `env.manifest.json` that maps KeyVault secret names to env var names.
The manifest for Progno is at `c:\cevict-live\apps\progno\env.manifest.json`.
The manifest for Prognostication is at `c:\cevict-live\apps\prognostication\env.manifest.json`.

---

## Troubleshooting

| Symptom | Cause | Fix |
|---------|-------|-----|
| `401 Unauthorized` | API key mismatch | Verify `PROGNO_INTERNAL_API_KEY` matches in both apps. Re-push to Vercel. |
| `No picks found` | Predictions not run yet | Run predictions first via admin UI or `npm run syndicate` |
| `PGRST205 schema cache` | PostgREST hasn't reloaded | Run `NOTIFY pgrst, 'reload schema';` in Supabase SQL editor |
| `Server configuration error` | Env var missing on Vercel | Check Vercel env vars for `PROGNO_INTERNAL_API_KEY` |
| Wrong Supabase project | Vercel pointing to old test DB | Verify `NEXT_PUBLIC_SUPABASE_URL` in Vercel = `rdbuwyefbgnbuhmjrizo` |
