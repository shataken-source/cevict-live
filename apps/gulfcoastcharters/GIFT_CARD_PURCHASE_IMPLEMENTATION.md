# Gift Certificate Purchase Flow - Implementation Complete

## ‚úÖ What Was Implemented

### 1. Purchase API Endpoint (`/api/gift-cards/purchase.ts`)
- Creates gift certificate record with `status: 'pending'`
- Validates amount ($25-$1000), emails, and required fields
- Finds sender user by email (optional - non-users can purchase)
- Creates Stripe checkout session via `stripe-checkout` Edge Function
- Returns checkout URL for redirect
- Cleans up gift certificate if checkout creation fails

### 2. Webhook Handler Update (`stripe-webhook/index.ts`)
- Handles `checkout.session.completed` events for gift cards
- Generates unique gift certificate code using `generate_gift_certificate_code()` RPC
- Updates gift certificate status from `pending` to `active`
- Stores Stripe payment intent ID
- Includes fallback code generation if RPC fails

### 3. UI Integration (`pages/gift-cards.tsx`)
- Updated `handlePurchase` to call `/api/gift-cards/purchase`
- Redirects to Stripe checkout on success
- Proper error handling and user feedback

## üîÑ Complete Flow

1. **User fills out form** on `/gift-cards` page
2. **Form submits** ‚Üí Calls `/api/gift-cards/purchase`
3. **API creates** gift certificate record (status: `pending`, code: `PENDING`)
4. **API calls** `stripe-checkout` Edge Function with `type: 'gift_card'`
5. **User redirected** to Stripe checkout
6. **User completes payment**
7. **Webhook receives** `checkout.session.completed` event
8. **Webhook generates** unique code (e.g., `GCC-A1B2C3D4`)
9. **Webhook updates** certificate to `active` status
10. **TODO:** Send email to recipient with gift card code

## üìã Next Steps (Optional Enhancements)

### Email Delivery
- Add email service integration (Resend/SendGrid)
- Create email template for gift card delivery
- Send email when webhook processes payment
- Include gift card code, amount, sender message

### Testing
1. Test purchase flow end-to-end
2. Verify gift certificate is created with `pending` status
3. Complete Stripe checkout
4. Verify webhook updates certificate to `active`
5. Verify unique code is generated
6. Check database for correct data

## üóÑÔ∏è Database Schema

The gift certificate record includes:
- `certificate_id` (UUID, primary key)
- `code` (text, unique) - Generated by webhook
- `purchaser_id` (UUID, nullable) - Sender's user ID if they have account
- `recipient_email` (text, required)
- `recipient_name` (text, nullable)
- `amount` (decimal, required)
- `remaining_balance` (decimal, starts at amount)
- `message` (text, nullable) - Personal message from sender
- `status` (enum: pending ‚Üí active)
- `stripe_payment_intent_id` (text) - Set by webhook
- `purchased_at` (timestamp)
- `created_at`, `updated_at` (timestamps)

## üîç Testing Checklist

- [ ] Purchase form validation works
- [ ] API creates pending gift certificate
- [ ] Stripe checkout redirects correctly
- [ ] Payment completes successfully
- [ ] Webhook receives event
- [ ] Gift certificate status updates to `active`
- [ ] Unique code is generated
- [ ] Payment intent ID is stored
- [ ] Certificate can be viewed in database

## üö® Important Notes

1. **Code Generation**: Uses `generate_gift_certificate_code()` RPC function from database migration
2. **Fallback**: If RPC fails, uses certificate ID substring as fallback code
3. **Non-User Purchases**: Gift cards can be purchased by non-registered users (purchaser_id can be null)
4. **Email Delivery**: Currently not implemented - needs email service integration
5. **Redemption**: Already implemented via `/api/gift-cards/redeem` endpoint

---

**Status:** ‚úÖ Core purchase flow complete - Ready for testing
