import tweepy
import time
import logging
from openai import OpenAI
import os
from dotenv import load_dotenv

load_dotenv()

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

API_KEY = os.getenv('TWITTER_API_KEY')
API_SECRET = os.getenv('TWITTER_API_SECRET')
ACCESS_TOKEN = os.getenv('TWITTER_ACCESS_TOKEN')
ACCESS_SECRET = os.getenv('TWITTER_ACCESS_SECRET')
OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')

if not all([API_KEY, API_SECRET, ACCESS_TOKEN, ACCESS_SECRET, OPENAI_API_KEY]):
    raise ValueError('Missing env vars - check .env file')

openai_client = OpenAI(api_key=OPENAI_API_KEY)

# REPLACE THIS with your @petreunion numeric ID
BOT_USER_ID = 1234567890123456789

LAST_ID_FILE = 'last_mention_id.txt'

def get_last_mention_id():
    try:
        with open(LAST_ID_FILE, 'r') as f:
            return int(f.read().strip())
    except (FileNotFoundError, ValueError):
        return None

def save_last_mention_id(tweet_id):
    with open(LAST_ID_FILE, 'w') as f:
        f.write(str(tweet_id))

def generate_reply(mention_text, author_username):
    system_prompt = """
You are a compassionate, helpful assistant for @PetReunion ‚Äî a community dedicated to reuniting lost and found pets quickly and safely.

Your tone is always warm, empathetic, supportive, and positive. Start by acknowledging their situation and showing you care (e.g., "I'm so sorry you're going through this" for lost pets, or "Thank you for helping a pet in need!" for found ones).

Key goals:
- Offer immediate emotional support
- Gently ask for missing details to help spread the word effectively: exact location/area (city/neighborhood/cross streets), pet description (breed, color, size, age, distinctive marks), when/where lost or found, recent clear photo if possible, microchip status, collar/tags?
- Provide 1‚Äì3 practical, high-impact tips relevant to the situation:
  - For lost: Post flyers in neighborhood/vets/shelters, check local shelters/rescues daily, notify microchip company if chipped, search at night (pets hide), ask neighbors/Facebook lost pet groups, make post public and ask shares.
  - For found: Keep pet safe indoors/secure, check for chip at vet/shelter, post found notice with location clues (but not exact address for safety), avoid assuming ownership quickly.
- Encourage them to share/boost the original post for more eyes
- End on hope: "We'll get them home soon üêæ" or similar
- Always include #PetReunion and tag @PetReunion if it fits naturally

Rules:
- Replies MUST start with @username to reply properly on X
- Keep total reply under 220 characters (X-friendly)
- Be concise ‚Äî no long lectures
- Never judge owners (no "they must have been careless" or similar)
- If the mention is vague/spam/not pet-related, reply briefly: "Hi! Could you share more about your pet situation? Happy to help üê∂‚ù§Ô∏è #PetReunion"
- Stay supportive even if it's a sad update

Generate only the reply text ‚Äî nothing else.
"""

    user_prompt = f"User's mention: '{mention_text}' from @{author_username}"

    try:
        response = openai_client.chat.completions.create(
            model='gpt-4o-mini',
            messages=[
                {'role': 'system', 'content': system_prompt},
                {'role': 'user', 'content': user_prompt}
            ],
            max_tokens=100,
            temperature=0.7,
        )
        reply_text = response.choices[0].message.content.strip()
        if not reply_text.startswith(f'@{author_username}'):
            reply_text = f'@{author_username} {reply_text}'
        return reply_text
    except Exception as e:
        logger.error(f'OpenAI error: {e}')
        return f'@{author_username} Hi! Sorry, small glitch ‚Äî could you resend your pet details? We're here to help üêæ #PetReunion'

def reply_to_mentions():
    client = tweepy.Client(
        consumer_key=API_KEY,
        consumer_secret=API_SECRET,
        access_token=ACCESS_TOKEN,
        access_token_secret=ACCESS_SECRET
    )

    since_id = get_last_mention_id()

    try:
        mentions = client.get_users_mentions(
            id=BOT_USER_ID,
            since_id=since_id,
            tweet_fields=['created_at', 'text'],
            expansions=['author_id'],
            user_fields=['username'],
            max_results=20
        )

        if not mentions.data:
            logger.info('No new mentions.')
            return

        users = {u.id: u for u in mentions.includes.get('users', [])}

        for mention in reversed(mentions.data):
            mention_id = mention.id
            author = users.get(mention.author_id)
            username = author.username if author else 'user'

            logger.info(f'Mention from @{username}: {mention.text[:60]}...')

            reply = generate_reply(mention.text, username)

            try:
                client.create_tweet(text=reply, in_reply_to_tweet_id=mention_id)
                logger.info(f'Replied: {reply[:60]}...')
            except tweepy.TweepyException as e:
                logger.error(f'Reply failed: {e}')

            save_last_mention_id(mention_id)

    except Exception as e:
        logger.error(f'Error in mentions fetch: {e}')

if __name__ == '__main__':
    logger.info('PetReunion Reply Bot started (checking every 10 min)')
    while True:
        try:
            reply_to_mentions()
        except Exception as e:
            logger.error(f'Main loop error: {e}')
        time.sleep(600)